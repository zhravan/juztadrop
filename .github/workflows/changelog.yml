name: Update Changelog

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install conventional-changelog-cli
        run: npm install -g conventional-changelog-cli

      - name: Generate changelog
        run: |
          # Check if any tags exist
          if git describe --tags --abbrev=0 2>/dev/null; then
            LATEST_TAG=$(git describe --tags --abbrev=0)
            echo "Latest tag found: ${LATEST_TAG}"

            # Check if there are new commits since the tag
            NEW_COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline --no-merges)

            if [ -z "$NEW_COMMITS" ]; then
              echo "No new commits since ${LATEST_TAG}"
              exit 0
            fi

            echo "Found new commits since ${LATEST_TAG}:"
            echo "$NEW_COMMITS"
          else
            echo "No tags found - this appears to be the first run"
            echo "Skipping changelog generation to avoid duplicates"
            echo "The CHANGELOG.md has already been manually populated"
            echo "Future runs will add new commits automatically"
            exit 0
          fi

          # Generate changelog only for commits since last tag
          conventional-changelog -p angular -i CHANGELOG.md -s

      - name: Commit and push changelog
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet CHANGELOG.md; then
            echo "No changelog changes"
            exit 0
          fi

          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md [skip ci]"
          git push
