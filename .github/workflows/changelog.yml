name: Update Changelog

on:
  push:
    branches:
      - main

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install conventional-changelog-cli
        run: npm install -g conventional-changelog-cli

      - name: Determine next version
        id: version
        run: |
          # Check if any tags exist
          if git describe --tags --abbrev=0 2>/dev/null; then
            LATEST_TAG=$(git describe --tags --abbrev=0)
            echo "Latest tag: ${LATEST_TAG}"

            # Check if there are new commits since the tag
            NEW_COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline --no-merges)

            if [ -z "$NEW_COMMITS" ]; then
              echo "No new commits since ${LATEST_TAG}"
              echo "should_release=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Extract version numbers (remove 'v' prefix)
            VERSION=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

            # Increment patch version
            PATCH=$((PATCH + 1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"

            echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
            echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "is_first=false" >> $GITHUB_OUTPUT
          else
            echo "No tags found - first release"
            echo "new_version=v1.0.0" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "is_first=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        if: steps.version.outputs.should_release == 'true'
        run: |
          if [ "${{ steps.version.outputs.is_first }}" = "true" ]; then
            echo "Generating changelog from all commits"
            conventional-changelog -p angular -i CHANGELOG.md -s -r 0
          else
            echo "Generating changelog since ${{ steps.version.outputs.latest_tag }}"
            conventional-changelog -p angular -i CHANGELOG.md -s
          fi

      - name: Commit changelog
        if: steps.version.outputs.should_release == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if CHANGELOG.md exists and has changes
          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md does not exist"
            exit 0
          fi

          # Add and check for changes
          git add CHANGELOG.md

          if git diff --cached --quiet -- CHANGELOG.md; then
            echo "No changelog changes"
          else
            git commit -m "docs: update CHANGELOG.md for ${{ steps.version.outputs.new_version }} [skip ci]"
          fi

      - name: Create and push tag
        if: steps.version.outputs.should_release == 'true'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          echo "Creating tag: ${NEW_VERSION}"
          git tag -a ${NEW_VERSION} -m "Release ${NEW_VERSION}"

          echo "Pushing tag and changes"
          git push origin ${NEW_VERSION}
          git push

      - name: Extract release notes
        if: steps.version.outputs.should_release == 'true'
        id: release_notes
        run: |
          # Extract the latest version section from CHANGELOG.md
          VERSION="${{ steps.version.outputs.new_version }}"
          VERSION_NO_V="${VERSION#v}"
          
          # Get content between this version and the next version header (or end of file)
          NOTES=$(awk "/^#+ .*${VERSION_NO_V}|^#+ \[${VERSION_NO_V}\]/,/^#+ [0-9]+\.[0-9]+\.[0-9]+|^#+ \[[0-9]+\.[0-9]+\.[0-9]+\]/{if(/^#+ [0-9]+\.[0-9]+\.[0-9]+|^#+ \[[0-9]+\.[0-9]+\.[0-9]+\]/ && !/^#+ .*${VERSION_NO_V}|^#+ \[${VERSION_NO_V}\]/)exit; print}" CHANGELOG.md | tail -n +2)
          
          if [ -z "$NOTES" ]; then
            NOTES="Release ${VERSION}"
          fi
          
          # Write to file for multi-line support
          echo "$NOTES" > release_notes.md

      - name: Create GitHub Release
        if: steps.version.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
